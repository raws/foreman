#!/usr/bin/env ruby

require "foreman"
require "thor"

class ForemanCLI < Thor
  desc "start [--config PATH]", "Start a Foreman server"
  option :config, aliases: ["-c"], banner: "PATH", desc: "Path to a Ruby configuration file"
  def start
    @server = Foreman::Server.new
    @server.logger.subscribe Foreman::Logging::StdoutAdapter.new do |adapter|
      adapter.level = Logger::INFO
    end

    trap_termination_signals
    load_config

    EventMachine.run do
      @server.start
    end

    restore_terminal_keyboard_output
  end

  private

  def load_config
    if options[:config]
      config_path = File.expand_path(options[:config])
      open(config_path) do |io|
        line_number = 1
        io.each_line do |line|
          eval line, binding, config_path, line_number
          line_number += 1
        end
      end
    end
  end

  def restore_terminal_keyboard_output
    system "stty echo"
  end

  def trap_termination_signals
    %w(INT TERM).each do |signal|
      trap(signal) do
        @server.logger.info "SIG#{signal} received, stopping server...", fields: { signal: signal }
        @server.stop
      end
    end
  end
end

ForemanCLI.start(ARGV)
