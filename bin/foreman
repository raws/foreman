#!/usr/bin/env ruby

require "foreman"
require "thor"

class ForemanCLI < Thor
  desc "start", "Start a Foreman server"
  def start
    @server = Foreman::Server.new
    @server.logger.subscribe Foreman::Logging::StdoutAdapter.new do |adapter|
      adapter.level = Logger::INFO
    end

    %w(INT TERM).each do |signal|
      trap(signal) do
        @server.logger.info "SIG#{signal} received, stopping server...", fields: { signal: signal }
        @server.stop
      end
    end

    EventMachine.run do
      @server.start
    end

    system "stty echo"
  end
end

ForemanCLI.start(ARGV)
